From 9b46345e683c27f47c8264ad8a01f1654269b1a1 Mon Sep 17 00:00:00 2001
From: "Peter Droogmans (attiks)" <peter@attiks.com>
Date: Thu, 29 Jun 2023 09:53:34 +0200
Subject: [PATCH 1/3] Use figure id in theme suggestions

---
 ocha_key_figures.module                       | 58 +++++++++++++++++++
 .../Field/FieldFormatter/KeyFigureBase.php    | 14 ++++-
 .../FieldFormatter/KeyFigureCondensed.php     |  2 +
 .../KeyFigurePresenceCondensed.php            |  2 +
 4 files changed, 74 insertions(+), 2 deletions(-)

diff --git a/ocha_key_figures.module b/ocha_key_figures.module
index c959b92..1153124 100644
--- a/ocha_key_figures.module
+++ b/ocha_key_figures.module
@@ -45,6 +45,8 @@ function ocha_key_figures_theme($existing, $type, $theme, $path) {
         'value' => NULL,
         'unit' => NULL,
         'country' => NULL,
+        'figure' => NULL,
+        'figure_id' => NULL,
         'year' => NULL,
         'value_prefix' => NULL,
         'value_suffix' => NULL,
@@ -79,3 +81,59 @@ function ocha_key_figures_system_breadcrumb_alter(\Drupal\Core\Breadcrumb\Breadc
     'id' => $id,
   ]));
 }
+
+/**
+ * Implements hook_theme_suggestions_HOOK().
+ */
+function ocha_key_figures_theme_suggestions_ocha_key_figures_extended_figure(array $variables) {
+  if (!isset($variables['figure']['figure_id'])) {
+    return [];
+  }
+
+  if (empty($variables['figure']['figure_id'])) {
+    return [];
+  }
+
+  $suggestions = [
+    'ocha_key_figures_extended_figure__' . $variables['figure']['figure_id'],
+  ];
+
+  $parts = explode('__', $variables['theme_hook_original']);
+  array_shift($parts);
+
+  $new = 'ocha_key_figures_extended_figure__' . $variables['figure']['figure_id'];
+  foreach ($parts as $part) {
+    $new .= '__' . $part;
+    $suggestions[] = $new;
+  }
+
+  return $suggestions;
+}
+
+/**
+ * Implements hook_theme_suggestions_HOOK().
+ */
+function ocha_key_figures_theme_suggestions_ocha_key_figures_figure(array $variables) {
+  if (!isset($variables['figure_id'])) {
+    return [];
+  }
+
+  if (empty($variables['figure_id'])) {
+    return [];
+  }
+
+  $suggestions = [
+    'ocha_key_figures_extended_figure__' . $variables['figure_id'],
+  ];
+
+  $parts = explode('__', $variables['theme_hook_original']);
+  array_shift($parts);
+
+  $new = 'ocha_key_figures_extended_figure__' . $variables['figure_id'];
+  foreach ($parts as $part) {
+    $new .= '__' . $part;
+    $suggestions[] = $new;
+  }
+
+  return $suggestions;
+}
diff --git a/src/Plugin/Field/FieldFormatter/KeyFigureBase.php b/src/Plugin/Field/FieldFormatter/KeyFigureBase.php
index 08f1ef6..2eb2a2d 100644
--- a/src/Plugin/Field/FieldFormatter/KeyFigureBase.php
+++ b/src/Plugin/Field/FieldFormatter/KeyFigureBase.php
@@ -150,11 +150,21 @@ public function viewElements(FieldItemListInterface $items, $langcode) {
    *   Associative array keyed by figure ID and with figures data as values.
    */
   protected function getFigures($provider, $country, $year) {
-    $data = $this->ochaKeyFiguresApiClient->query($provider, '', [
+    $query = [
       'iso3' => $country,
       'year' => $year,
       'archived' => 0,
-    ]);
+    ];
+
+    // Special case for year.
+    if ($year == 1) {
+      unset($query['year']);
+    }
+    elseif ($year == 2) {
+      $query['year'] = date('Y');
+    }
+
+    $data = $this->ochaKeyFiguresApiClient->query($provider, '', $query);
 
     $figures = [];
 
diff --git a/src/Plugin/Field/FieldFormatter/KeyFigureCondensed.php b/src/Plugin/Field/FieldFormatter/KeyFigureCondensed.php
index 58c380a..083422e 100644
--- a/src/Plugin/Field/FieldFormatter/KeyFigureCondensed.php
+++ b/src/Plugin/Field/FieldFormatter/KeyFigureCondensed.php
@@ -68,6 +68,8 @@ public function viewElements(FieldItemListInterface $items, $langcode) {
           '#value' => $value,
           '#unit' => $figure['unit'] ?? '',
           '#country' => $figure['country'],
+          '#figure_id' => $figure['figure_id'] ?? '',
+          '#figure' => $figure,
           '#year' => $figure['year'],
           '#value_prefix' => $figure['prefix'] ?? '',
           '#value_suffix' => $figure['suffix'] ?? '',
diff --git a/src/Plugin/Field/FieldFormatter/KeyFigurePresenceCondensed.php b/src/Plugin/Field/FieldFormatter/KeyFigurePresenceCondensed.php
index 35769c2..60010cd 100644
--- a/src/Plugin/Field/FieldFormatter/KeyFigurePresenceCondensed.php
+++ b/src/Plugin/Field/FieldFormatter/KeyFigurePresenceCondensed.php
@@ -87,6 +87,8 @@ public function viewElements(FieldItemListInterface $items, $langcode) {
         '#value' => $figure['value'],
         '#unit' => $figure['unit'],
         '#country' => $figure['country'],
+        '#figure_id' => $figure['figure_id'] ?? '',
+        '#figure' => $figure,
         '#year' => $figure['year'],
         '#value_prefix' => $figure['prefix'] ?? '',
         '#value_suffix' => $figure['suffix'] ?? '',

From d234ef0036bed26dc6366932941df66f81d803b2 Mon Sep 17 00:00:00 2001
From: "Peter Droogmans (attiks)" <peter@attiks.com>
Date: Thu, 29 Jun 2023 10:54:11 +0200
Subject: [PATCH 2/3] Use figure id in theme suggestions

---
 ocha_key_figures.module                                | 8 ++++----
 src/Plugin/Field/FieldFormatter/KeyFigureCondensed.php | 5 ++++-
 2 files changed, 8 insertions(+), 5 deletions(-)

diff --git a/ocha_key_figures.module b/ocha_key_figures.module
index 1153124..63e9ea0 100644
--- a/ocha_key_figures.module
+++ b/ocha_key_figures.module
@@ -94,14 +94,14 @@ function ocha_key_figures_theme_suggestions_ocha_key_figures_extended_figure(arr
     return [];
   }
 
+  $new = 'ocha_key_figures_extended_figure__' . str_replace('-', '_', $variables['figure']['figure_id']);
   $suggestions = [
-    'ocha_key_figures_extended_figure__' . $variables['figure']['figure_id'],
+    $new,
   ];
 
   $parts = explode('__', $variables['theme_hook_original']);
   array_shift($parts);
 
-  $new = 'ocha_key_figures_extended_figure__' . $variables['figure']['figure_id'];
   foreach ($parts as $part) {
     $new .= '__' . $part;
     $suggestions[] = $new;
@@ -122,14 +122,14 @@ function ocha_key_figures_theme_suggestions_ocha_key_figures_figure(array $varia
     return [];
   }
 
+  $new = 'ocha_key_figures_figure__' . str_replace('-', '_', $variables['figure_id']);
   $suggestions = [
-    'ocha_key_figures_extended_figure__' . $variables['figure_id'],
+    $new,
   ];
 
   $parts = explode('__', $variables['theme_hook_original']);
   array_shift($parts);
 
-  $new = 'ocha_key_figures_extended_figure__' . $variables['figure_id'];
   foreach ($parts as $part) {
     $new .= '__' . $part;
     $suggestions[] = $new;
diff --git a/src/Plugin/Field/FieldFormatter/KeyFigureCondensed.php b/src/Plugin/Field/FieldFormatter/KeyFigureCondensed.php
index 083422e..9cf3399 100644
--- a/src/Plugin/Field/FieldFormatter/KeyFigureCondensed.php
+++ b/src/Plugin/Field/FieldFormatter/KeyFigureCondensed.php
@@ -87,6 +87,7 @@ public function viewElements(FieldItemListInterface $items, $langcode) {
         $value = $item->getFigureValue();
         $unit = $item->getFigureUnit();
 
+        $data = [];
         if ($item->getFigureProvider() != 'manual') {
           $data = $this->ochaKeyFiguresApiClient->getFigure($item->getFigureProvider(), strtolower($item->getFigureId()));
 
@@ -104,11 +105,13 @@ public function viewElements(FieldItemListInterface $items, $langcode) {
         if (isset($label, $value)) {
           $value = $this->formatNumber($value, $langcode);
           $elements['#figures'][$delta] = [
-            '#theme' => 'ocha_key_figures_figure__' . $this->viewMode,
+            '#theme' => 'ocha_key_figures_figure__' . $theme_suggestions,
             '#label' => $label,
             '#value' => $value,
             '#unit' => $unit,
             '#country' => $item->getFigureCountry(),
+            '#figure_id' => $data['figure_id'] ?? '',
+            '#figure' => $data,
             '#year' => $item->getFigureYear(),
             '#value_prefix' => $data['prefix'] ?? '',
             '#value_suffix' => $data['suffix'] ?? '',

From c89856714a15a4821d1fd3762fbbfa9ad30e27bb Mon Sep 17 00:00:00 2001
From: "Peter Droogmans (attiks)" <peter@attiks.com>
Date: Mon, 3 Jul 2023 16:31:57 +0200
Subject: [PATCH 3/3] bug: Fix current year

---
 src/Controller/OchaKeyFiguresController.php | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/src/Controller/OchaKeyFiguresController.php b/src/Controller/OchaKeyFiguresController.php
index 60196a3..813f2ee 100644
--- a/src/Controller/OchaKeyFiguresController.php
+++ b/src/Controller/OchaKeyFiguresController.php
@@ -846,6 +846,10 @@ public function setOchaPresenceExternal(string $id, $data, $new = FALSE) : array
   public function getOchaPresenceFigures(string $provider, string $ocha_presence_id, string $year, $figure_ids = []) : array {
     $prefix = $this->getPrefix($provider);
 
+    if ($year == 2) {
+      $year = date('Y');
+    }
+
     $query = [];
     if (!empty($figure_ids)) {
       $query['figure_id'] = $figure_ids;
